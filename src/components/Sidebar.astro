---
// src/components/Sidebar.astro
import { Image } from 'astro:assets';
import { urlFor } from '../lib/sanity.ts';
import { ui } from '../i18n/ui.ts';
import { getRelativeLocaleUrl } from 'astro:i18n';
import Footer from './Footer.astro';
import ContactModal from './ContactModal.jsx';
import ScrollAwareNav from './ScrollAwareNav.jsx';
import HeroShrinkHeader from './HeroShrinkHeader.jsx';

const { settings } = Astro.props;
const fotoUrl = settings?.foto ? urlFor(settings.foto).url() : '';

const getLangFromUrl = (url: URL) => url.pathname.split('/')[1] || 'ca';
const lang = getLangFromUrl(Astro.url) as keyof typeof ui;
const t = ui[lang];
---

<aside class="w-full lg:w-2/5 lg:h-screen lg:sticky top-0 
              bg-white dark:bg-slate-950 
              lg:bg-gradient-to-b lg:from-slate-50 lg:via-white lg:to-slate-100 
              dark:lg:from-slate-900 dark:lg:via-slate-950 dark:lg:to-slate-900 
              p-6 lg:p-10 flex flex-col justify-between 
              border-b lg:border-b-0 lg:border-r border-slate-200 dark:border-slate-700">

  <!-- TOP: idioma i tema -->
  <header class="flex justify-end items-center gap-2 mb-6">
    <div class="flex items-center gap-2 text-sm font-medium" aria-label="Idioma">
      <a href={getRelativeLocaleUrl('ca')} class={Astro.currentLocale === 'ca' ? 'font-bold text-indigo-600' : ''}>CA</a>
      <span>|</span>
      <a href={getRelativeLocaleUrl('es')} class={Astro.currentLocale === 'es' ? 'font-bold text-indigo-600' : ''}>ES</a>
      <span>|</span>
      <a href={getRelativeLocaleUrl('en')} class={Astro.currentLocale === 'en' ? 'font-bold text-indigo-600' : ''}>EN</a>
    </div>

    <button 
      id="theme-toggle"
      aria-label="Canviar tema"
      type="button"
      class="relative w-12 h-12 flex items-center justify-center rounded-full text-slate-600 dark:text-indigo-600 hover:bg-slate-200 dark:hover:bg-slate-800 focus:outline-none transition-all duration-300 ease-in-out hover:scale-110"
    >
      <div class="relative w-6 h-6">
        <i class="fas fa-sun absolute inset-0 text-xl transition-all duration-500 ease-in-out transform dark:-rotate-90 dark:opacity-0"></i>
        <i class="fas fa-moon absolute inset-0 text-xl transition-all duration-500 ease-in-out transform rotate-90 opacity-0 dark:rotate-0 dark:opacity-100"></i>
      </div>
    </button>
  </header>

  <!-- MIDDLE: HERO -->
  <div class="flex-grow flex flex-col justify-center">
    {settings?.foto && (
      <Image
        src={urlFor(settings.foto).url()}
        width={96}
        height={96}
        alt={`Foto de ${settings.nom}`}
        class="h-24 w-24 rounded-full object-cover mb-6 ring-2 ring-indigo-500 shadow-xl mx-auto"
      />
    )}

    <h1 class="text-4xl lg:text-5xl font-extrabold text-center text-slate-900 dark:text-white leading-tight tracking-tight">
      {settings?.nom}
    </h1>

    <h2 class="text-xl font-semibold text-center text-indigo-600 dark:text-indigo-400 mt-2 tracking-wide">
      {settings?.titol}
    </h2>

    <p class="mt-6 text-center text-base leading-relaxed text-slate-600 dark:text-slate-400 italic max-w-sm mx-auto">
      {settings?.resumSidebar}
    </p>

    <ContactModal client:only="react" t={t} />


    <ScrollAwareNav client:load t={t} />
  </div>

  <!-- BOTTOM: accions i footer -->
  <div class="mt-6 flex justify-center gap-4 text-xl">
    {settings?.cvPdf && (
      <a href={settings.cvPdf} target="_blank" download title="Descarregar CV" class="text-slate-500 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors">
        <i class="fa-solid fa-file-arrow-down"></i>
      </a>
    )}
    {settings?.linkedinUrl && (
      <a href={settings.linkedinUrl} aria-label={`LinkedIn de ${settings.nom}`} target="_blank" class="text-slate-500 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors">
        <i class="fa-brands fa-linkedin"></i>
      </a>
    )}
    {settings?.githubUrl && (
      <a href={settings.githubUrl} aria-label={`GitHub de ${settings.nom}`} target="_blank" class="text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors">
        <i class="fa-brands fa-github"></i>
      </a>
    )}
    {settings?.email && (
      <a href={`mailto:${settings.email}`} aria-label={`Email de ${settings.nom}`} class="text-slate-500 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors">
        <i class="fa-solid fa-envelope"></i>
      </a>
    )}
  </div>

    <div class="hidden lg:block pt-10">
      <Footer nom={settings.nom} t={t} />
    </div>
  </div>
  <HeroShrinkHeader client:only="react" fotoUrl={fotoUrl} nom={settings.nom} titol={settings.titol} />

</aside>
