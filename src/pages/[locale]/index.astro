---
// src/pages/index.astro
import Layout from '../../layouts/Layout.astro';
import Sidebar from '../../components/Sidebar.astro';
import client from '../../lib/sanity.ts'; 
import Experiencia from '../../components/sections/Experiencia.astro';
import Habilitats from '../../components/sections/Habilitats.astro';
import Formacio from '../../components/sections/Formacio.astro';
import SobreMi from '../../components/sections/SobreMi.astro';
import { getLangFromUrl, useTranslations } from '../../i18n/utils';

// Substituïm 'const lang = 'ca';' per aquesta línia:
const lang = Astro.currentLocale || 'ca';

// Consulta a Sanity per obtenir les dades del portafoli
// La teva consulta adaptada per a i18n
const query = `*[_type == "siteSettings"][0]{
    // --- Camps NO traduïts (es queden igual) ---
    nom,
    foto,
    "cvPdf": cvPdf.asset->url,
    linkedinUrl,
    githubUrl,
    email,

    // --- Camps traduïts de siteSettings ---
    "titol": titol.${lang},
    "resumSidebar": resumSidebar.${lang},
    "descripcioSobreMi": descripcioSobreMi.${lang},

    // --- Sub-consultes amb camps traduïts ---
    "experiencies": *[_type == "experiencia"] | order(ordre asc) {
        empresa,
        dates,
        tecnologies,
        "titol": titol.${lang},
        "descripcio": descripcio.${lang}
    },
    "formacions": *[_type == "formacio"] | order(ordre asc) {
        centre,
        dates,
        "titulacio": titulacio.${lang}
    },
    "habilitatsTecniques": *[_type == "habilitat" && categoria == "tecnica"] | order(nom asc) {
        "nom": nom.${lang}
    },
    "habilitatsClau": *[_type == "habilitat" && categoria == "clau"] | order(nom asc) {
        "nom": nom.${lang}
    }
}`; 
const data = await client.fetch(query);
---
<Layout title={data?.nom || 'Portafoli Aitor Rivera'}>
	<div class="max-w-screen-xl mx-auto lg:flex">
		<Sidebar settings={data} />
		<main class="w-full lg:w-3/5 p-8 lg:p-16 lg:py-24">
			{data ? (
				<>
					<SobreMi sobremi={data.descripcioSobreMi}/>

                    <Experiencia experiencies={data.experiencies} />
					
                    <Habilitats tecniques={data.habilitatsTecniques} clau={data.habilitatsClau} />
					
                    <Formacio formacions={data.formacions} />

				</>
			) : (
				<div class="bg-slate-800 text-slate-200 p-8 rounded-lg"><p>Connectant amb Sanity...</p></div>
			)}
		</main>
	</div>
</Layout>