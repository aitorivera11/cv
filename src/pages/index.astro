---
// src/pages/index.astro (VERSIÓ FINAL AMB EINES PRÒPIES)
import Layout from '../layouts/Layout.astro';

// 1. Importem DES DEL NOSTRE FITXER
import client, { urlFor } from '../lib/sanity.ts'; 
import { PortableText } from 'astro-portabletext';

const query = `*[_type == "siteSettings"][0]{
  ...,
  "cvUrl": cvPdf.asset->url,
  "experiencies": *[_type == "experiencia"] | order(ordre asc),
  "formacions": *[_type == "formacio"] | order(ordre asc),
  "habilitatsTecniques": *[_type == "habilitat" && categoria == "tecnica"],
  "habilitatsClau": *[_type == "habilitat" && categoria == "clau"]
}`;

const data = await client.fetch(query);
---

<Layout title={data?.nom || 'Portafoli Aitor Rivera'}>
    <div class="page-wrapper">
        <aside class="sidebar">
            <div class="sidebar-content">
                {data?.foto && <img src={urlFor(data.foto).width(240).url()} alt={`Foto de ${data.nom}`} class="sidebar-photo">}
                <h1 class="sidebar-title">{data?.nom}</h1>
                <h2 class="sidebar-subtitle">{data?.titol}</h2>
                <p class="sidebar-summary">{data?.resumSidebar}</p>

                <nav class="sidebar-nav">
                    <a href="#sobre-mi">Sobre Mi</a>
                    <a href="#experiencia">Experiència</a>
                    <a href="#habilitats">Habilitats</a>
                    <a href="#formacio">Formació</a>
                </nav>

                {data?.cvUrl && <a href={data.cvUrl} download class="btn-download"><i class="fa-solid fa-download"></i> Descarregar CV</a>}

                <div class="sidebar-contact">
                    {data?.linkedinUrl && <a href={data.linkedinUrl} target="_blank" title="LinkedIn"><i class="fa-brands fa-linkedin"></i></a>}
                    {data?.githubUrl && <a href={data.githubUrl} target="_blank" title="GitHub"><i class="fa-brands fa-github"></i></a>}
                    {data?.email && <a href={`mailto:${data.email}`} title="Correu Electrònic"><i class="fa-solid fa-envelope"></i></a>}
                </div>
            </div>
        </aside>

        <main class="main-content">
            {data ? (
            <>
                <section id="sobre-mi" class="content-section">
                    <div class="intro-card hidden">
                        <p>Soc un desenvolupador apassionat per la tecnologia i la innovació, amb una trajectòria dual que em permet tant construir solucions tècniques robustes com liderar projectes complexos. El meu objectiu és aportar valor en entorns dinàmics, aplicant un alt sentit de la responsabilitat i un compromís total amb cada repte.</p>
                    </div>
                </section>
                <section id="experiencia" class="content-section">
                    <h3 class="content-title hidden">Experiència</h3>
                    {data.experiencies?.map(feina => (
                        <div class="experience-card hidden">
                            <h4>{feina.titol}</h4>
                            <h5>{feina.empresa} | {feina.dates}</h5>
                            <div class="description-content">
                                <PortableText value={feina.descripcio} />
                            </div>
                            <div class="experience-tags">
                                {feina.tecnologies?.map(tag => <span class="tech-tag">{tag}</span>)}
                            </div>
                        </div>
                    ))}
                </section>
                <section id="habilitats" class="content-section">
                    <h3 class="content-title hidden">Habilitats</h3>
                    <div class="skills-container">
                        <div class="skill-card hidden">
                            <h5>Tècniques</h5>
                            <div class="skills-grid">
                                {data.habilitatsTecniques?.map(hab => <span class="skill-tag">{hab.nom}</span>)}
                            </div>
                        </div>
                        <div class="skill-card hidden">
                            <h5>Competències Clau</h5>
                            <div class="skills-grid">
                                {data.habilitatsClau?.map(hab => <span class="skill-tag">{hab.nom}</span>)}
                            </div>
                        </div>
                    </div>
                </section>
                <section id="formacio" class="content-section">
                    <h3 class="content-title hidden">Formació</h3>
                    {data.formacions?.map(estudi => (
                        <div class="education-card hidden">
                            <h4>{estudi.titulacio}</h4>
                            <p>{estudi.centre} | {estudi.dates}</p>
                        </div>
                    ))}
                </section>
                <footer class="main-footer hidden">
                    <p>&copy; {new Date().getFullYear()} {data.nom}</p>
                </footer>
            </>
        ) : (
            <div class="intro-card">
                <p>Connectant amb Sanity i carregant les dades... Si aquest missatge persisteix, assegura't que has creat i publicat una entrada a la secció "Configuració del Lloc" del teu Sanity Studio.</p>
            </div>
        )}
        </main>
    </div>
</Layout>